---
# - name: Ensure Docker service is running and setup user access
#   include_role:
#     name: common
#     tasks_from: setup_docker_user
#   vars:
#     target_user: "{{ docker_user }}"

- name: Ensure docker networks exist
  community.docker.docker_network:
    name: "{{ network_item }}"
    state: present
  loop:
    - traefik_proxy
  loop_control:
    loop_var: network_item

- name: Get user information
  getent:
    database: passwd
    key: "{{ docker_user }}"

- name: Set UID and GID facts
  set_fact:
    target_uid: "{{ getent_passwd[docker_user][1] }}"
    target_gid: "{{ getent_passwd[docker_user][2] }}"

- name: Create Traefik directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ target_uid}}"
    group: "{{ target_gid }}"
    recurse: true
    mode: "0755"
  loop:
    - "{{ traefik_base_path }}"
    - "{{ traefik_config }}"
    - "{{ traefik_logs }}"

- name: Create Traefik directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ target_uid}}"
    group: "{{ target_gid }}"
    recurse: true
    mode: "0700"
  loop:
    - "{{ traefik_certs }}"

- name: Create Traefik config file from template
  template:
    src: templates/traefik.yaml.j2
    dest: "{{ traefik_config }}/traefik.yaml"
    owner: "{{ target_uid}}"
    group: "{{ target_gid }}"

- name: Install apache2-utils
  package:
    name: apache2-utils
    state: present

- name: Generate password hash using htpasswd
  command:
    cmd: "htpasswd -bnBC 10 'shajal' {{ traefik_dashboard_password }}"
  register: htpasswd_hash
  changed_when: false

- name: Display the generated password hash
  debug:
    msg: "Generated hash: {{ htpasswd_hash.stdout }}"

- name: Stat docker socket
  become: true
  ansible.builtin.stat:
    path: /var/run/docker.sock
  register: docker_sock

- name: Deploy Traefik container
  community.docker.docker_container:
    name: traefik
    image: traefik:latest
    user: "{{ target_uid }}:{{ target_gid }}"
    groups:
      - "{{ docker_sock.stat.gid }}"
    ports:
      - "80:80"
      - "443:443"
    env:
      TRAEFIK_DASHBOARD_CREDENTIALS: "{{ htpasswd_hash.stdout }}"
      CF_API_EMAIL: "{{ traefik_cloudflare_email }}" # Cloudflare email
      CF_DNS_API_TOKEN: "{{ traefik_cf_dns_api_token }}" # Cloudflare API Token
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ traefik_config }}/traefik.yaml:/etc/traefik/traefik.yaml:ro"
      - "{{ traefik_config }}:/etc/traefik/conf/"
      - "{{ traefik_certs }}:/etc/traefik/certs/"
      - "{{ traefik_logs }}:/var/log/traefik/"
    labels:
      com.docker.compose.project: "traefik_stack"
      com.docker.compose.service: "traefik"
      traefik.enable: "true"
      traefik.http.routers.traefik.entrypoints: "http"
      traefik.http.routers.traefik.rule: "Host(`{{ traefik_domain }}`)"
      traefik.http.middlewares.traefik-auth.basicauth.users: "{{ htpasswd_hash.stdout }}"
      traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme: "https"
      traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto: "https"
      traefik.http.routers.traefik.middlewares: "traefik-https-redirect"
      traefik.http.routers.traefik-secure.entrypoints: "https"
      traefik.http.routers.traefik-secure.rule: "Host(`{{ traefik_domain }}`)"
      traefik.http.routers.traefik-secure.middlewares: "traefik-auth"
      traefik.http.routers.traefik-secure.tls: "true"
      traefik.http.routers.traefik-secure.tls.certresolver: "cloudflare"
      traefik.http.routers.traefik-secure.tls.domains[0].main: "{{ traefik_subdomain }}"
      traefik.http.routers.traefik-secure.tls.domains[0].sans: "*.{{ traefik_subdomain }}"
      traefik.http.routers.traefik-secure.service: "api@internal"
    networks:
      - name: traefik_proxy
    restart_policy: unless-stopped
    state: started

- name: Traefik deployed
  debug:
    msg: "Traefik is running successfully"

# required
# traefik.http.routers.syncthing-secure.entrypoints: "https"
# traefik.http.routers.syncthing-secure.rule: "Host(`syncthing.{{ traefik_subdomain }}`)"
# traefik.http.routers.syncthing-secure.tls: "true"


# optional
# traefik.http.routers.syncthing.entrypoints: "http"
# traefik.http.routers.syncthing.rule: "Host(`syncthing.{{ traefik_subdomain }}`)"
# traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme: "https"
# traefik.http.routers.syncthing-secure.middlewares: "traefik-https-redirect"
# traefik.http.routers.syncthing-secure.service: "syncthing"
# traefik.http.services.syncthing.loadbalancer.server.port: "8384"
# traefik.docker.network: "traefik_proxy"
# traefik.http.routers.syncthing-secure.tls.certresolver: "cloudflare"
