#!/usr/bin/env bash
set -Eeuo pipefail

backup_path="/apps/{{ app_name }}/db_backups"
now="$(date +%Y%m%d-%H%M%S)"
mkdir -p "$backup_path"
export PGPASSWORD="{{ db_to_backup_password }}"

dest="$backup_path/{{ app_name }}-${now}.sql.gz"
tmp="$(mktemp "$backup_path/{{ app_name }}-${now}.XXXXXX.sql.gz")"
trap 'rm -f -- "$tmp"' EXIT

pg_dump -h "{{ container_name }}" -p "5432" -U "{{ db_user }}" -d "{{ db_name }}" \
  -F p --no-owner --no-privileges | gzip -c > "$tmp"

gzip -t "$tmp"

mv -f -- "$tmp" "$dest"
trap - EXIT

find "$backup_path" -type f -name "{{ app_name }}-*.sql.gz" -mtime +{{ db_backup_retain }} -delete